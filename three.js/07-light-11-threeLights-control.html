<!--------------------------------------------------------------------------------
	
	Aplikacja three.js - 07 swiatlo
    trzy ruchome swiatla R, G, B ponad plaszczyzna
    mozna wybrac swiatlo i zmieniac jego intensywnosc
	
	
	P.Kowalczyk pazdziernik 2018
	

Zmiany:
wersja orginalna							P.K. 21/10/2018

-------------------------------------------------------------------------------->

<!DOCTYPE html>
<html>
	<head>
		<meta charset=utf-8>
		<title>07-Light-11</title>
		<style>
			body { margin: 0; }
			canvas { width: 100%; height: 100% }
		</style>
	</head>
	<body>

        <div id="WebGL-output" style="position: absolute; top: 0px;"> 	</div>
        
        <div style="position: absolute; top: 0px; left: 50%; text-align: center; z-index: 1; background-color: green;">
                Kliknij na swiatlo aby je wybrac.<br>
                'Q' & 'A' ruch swiatla gora dol <br>
                'W' & 'S' intensywnosc swiatla gora dol <br>
                'SPACE' reset do wartosci domyslnych
        </div>

        <div id="output", style="position: absolute; z-index: 1; top: 0px; background-color: green;">
            Tu pojawia sie informacje o wybranym obiekcie
        </div>
            

		<script src="js/three.js"></script>
		<script>
            var mouse = new THREE.Vector2();
            var raycaster = new THREE.Raycaster();
			var scene = new THREE.Scene();
			var camera = new THREE.PerspectiveCamera( 75, window.innerWidth/window.innerHeight, 0.1, 1000 );
            var lightsG = new THREE.Group();
            var currObject;
            var color = 0;
            var colorStep = 0x050505;


            var key = [];

            //obsluga klawiatury
            document.addEventListener("keydown", function(event) {key[event.keyCode] = true;});
            document.addEventListener("keyup", function(event) {key[event.keyCode] = false;});

            ///////////////////////////
            //sprawdz gdzie kliknieto
            //
            document.addEventListener("click",  onMouseClick );




			var renderer = new THREE.WebGLRenderer();
			renderer.setSize( window.innerWidth, window.innerHeight );
			//document.body.appendChild( renderer.domElement );
            document.getElementById("WebGL-output").appendChild(renderer.domElement);

			//tworzymy swiatlo ambient
			var ambientLight = new THREE.AmbientLight( 0x808080 );
			//scene.add(ambientLight);
			
			////////////////////////////////////////
			//tworzymy swiatlo punktowe R
			var rLightGroup = new THREE.Group();
			var lightR = new THREE.PointLight( 0xff0000, 1, 100 );
			//light.position.set( 0, 0, 0.0 );
			var bulbR = new THREE.Mesh( new THREE.SphereGeometry( 0.1, 10, 10), new THREE.MeshBasicMaterial({color: 0xff0000}) );
			lightR.position.set( 0, 0, 2.0 );
			bulbR.position.set( 0, 0, 2.0 );
			rLightGroup.add(lightR);
			rLightGroup.add(bulbR);

			//scene.add( rLightGroup );
            lightsG.add(rLightGroup);

			////////////////////////////////////////
			//tworzymy swiatlo punktowe G
			var gLightGroup = new THREE.Group();
			var lightG = new THREE.PointLight( 0x00ff00, 1, 100 );
			var bulbG = new THREE.Mesh( new THREE.SphereGeometry( 0.1, 10, 10), new THREE.MeshBasicMaterial({color: 0x00ff00}) );
			lightG.position.set( 0, 0, 2.2 );
			bulbG.position.set( 0, 0, 2.2 );
			gLightGroup.add(lightG);
			gLightGroup.add(bulbG);

			//scene.add( gLightGroup );
            lightsG.add(gLightGroup);

			////////////////////////////////////////
			//tworzymy swiatlo punktowe B
			var bLightGroup = new THREE.Group();
			var lightB = new THREE.PointLight( 0x0000ff, 1, 100 );
			var bulbB = new THREE.Mesh( new THREE.SphereGeometry( 0.1, 10, 10), new THREE.MeshBasicMaterial({color: 0x0000ff}) );
			lightB.position.set( 0, 0, 1.8 );
			bulbB.position.set( 0, 0, 1.8 );
			bLightGroup.add(lightB);
			bLightGroup.add(bulbB);

			//scene.add( bLightGroup );
            lightsG.add(bLightGroup);

            

    		scene.add( lightsG );

			var plane = new THREE.Mesh( new THREE.PlaneGeometry( 5, 5, 10), new THREE.MeshStandardMaterial() );
			//var plane = new THREE.Mesh( new THREE.BoxGeometry( 1, 1, 1), new THREE.MeshStandardMaterial() );
            plane.position.set (0, -1, 0);
            plane.rotation.x = -Math.PI/2;

			scene.add( plane );

			camera.position.z = 4;
            camera.updateMatrixWorld();

			var animate = function () {
				requestAnimationFrame( animate );

                keyboard();

				rLightGroup.rotation.y += 0.005;
				gLightGroup.rotation.y += 0.0075;
				bLightGroup.rotation.y += 0.0025;
                
                if(currObject){
                   color += colorStep;
                   currObject.material.color = new THREE.Color(color | currObject.material.oldColor.getHex());

                   //console.log((color| currObject.material.oldColor).toString(16) +"; oldColor = " + currObject.material.oldColor.toString(16));
                    if(color == 0xffffff || color == 0) 
                        colorStep = -colorStep;

                    document.getElementById("output").innerHTML = 
                        "position.y = \t" + currObject.position.y.toFixed(2) + "<br>" +
                        "light intensity = \t" +currObject.parent.children[0].intensity.toFixed(2);

                }

                //

				renderer.render(scene, camera);
			};

			animate();		


            function onMouseClick(event) {
                mouse.x = ( event.clientX / window.innerWidth ) * 2 - 1;
	            mouse.y = - ( event.clientY / window.innerHeight ) * 2 + 1;

                raycaster.setFromCamera( mouse, camera );
                var intersects = raycaster.intersectObjects( lightsG.children, true );

                if(intersects.length > 0){
                    if(currObject != intersects[0].object){
                        color = 0;
                        intersects[0].object.material.oldColor = intersects[0].object.material.color;
                        if(currObject)
                            currObject.material.color = currObject.material.oldColor;
                        currObject = intersects[0].object;
                        // currObject.material.color = new THREE.Color(0xffffff);

                        ///////////////////////////
                        //Poszukajmy indeksu odpowiedniego swiatla

                    }
                }
               // console.log(intersects.length);
            }

            function keyboard() {
                if(!currObject)
                    return;


                if (key['q'.charCodeAt(0)] || key['Q'.charCodeAt(0)]) {
                    currObject.parent.children[0].position.add(new THREE.Vector3(0, 0.02, 0));
                    currObject.parent.children[1].position.add(new THREE.Vector3(0, 0.02, 0));
                } 
                if (key['a'.charCodeAt(0)] || key['A'.charCodeAt(0)]) {
                    currObject.parent.children[0].position.add(new THREE.Vector3(0, -0.02, 0));
                    currObject.parent.children[1].position.add(new THREE.Vector3(0, -0.02, 0));
                } 
                if (key['w'.charCodeAt(0)] || key['W'.charCodeAt(0)]) {
                    currObject.parent.children[0].intensity += 0.01;
                } 
                if (key['s'.charCodeAt(0)] || key['S'.charCodeAt(0)]) {
                    currObject.parent.children[0].intensity -= 0.01;
                } 
               if (key[32]) {
                currObject.parent.children[0].position.setComponent(1, 0.0);
                currObject.parent.children[1].position.setComponent(1, 0.0);
                currObject.parent.children[0].intensity = 1;
                } 

};


		</script>
	</body>
</html>