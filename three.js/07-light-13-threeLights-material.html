<!--------------------------------------------------------------------------------
	
	Aplikacja three.js - 07 swiatlo
    trzy ruchome swiatla R, G, B ponad plaszczyzna
    mozna wybrac swiatlo i zmieniac jego intensywnosc
	
	
	P.Kowalczyk pazdziernik 2018
	

Zmiany:
wersja orginalna							P.K. 27/10/2018

-------------------------------------------------------------------------------->

<!DOCTYPE html>
<html>
	<head>
		<meta charset=utf-8>
		<title>07-Light-13</title>
		<style>
			body { margin: 0; }
			canvas { width: 100%; height: 100% }
		</style>
	</head>
	<body>

        <div id="WebGL-output" style="position: absolute; top: 0px;"> 	</div>
        
        <div style="position: absolute; top: 0px; left: 50%; text-align: center; z-index: 1; background-color: green;">
                Kliknij na swiatlo aby je wybrac.<br>
                'Q' & 'A' ruch swiatla gora dol <br>
                'W' & 'S' intensywnosc swiatla gora dol <br>
                'E' & 'D' Podzial plaszczyzny na trojkaty <br>
                'R' & 'F' Shininess (lsnienie) [Phong i Toon]<br>
                'SPACE' reset do wartosci domyslnych <br>
                'LMB' na podlozu zmienia material
        </div>

        <div id="output", style="position: absolute; z-index: 1; top: 0px; background-color: green;">
            Tu pojawia sie informacje o wybranym obiekcie
        </div>
            

		<script src="js/three.js"></script>
		<script>
            var mouse = new THREE.Vector2();
            var raycaster = new THREE.Raycaster();
			var scene = new THREE.Scene();
			var camera = new THREE.PerspectiveCamera( 75, window.innerWidth/window.innerHeight, 0.1, 1000 );
            var lightsG = new THREE.Group();
            var currObject;
            var color = 0;
            var colorStep = 0x050505;
            var materials = [];
            materials.push( new THREE.MeshBasicMaterial({name: "MeshBasicMaterial"}) );
            materials.push( new THREE.MeshLambertMaterial({name: "MeshLambertMaterial"}));
            materials.push( new THREE.MeshPhongMaterial({name: "MeshPhongMaterial"}));
            materials.push( new THREE.MeshToonMaterial({name: "MeshToonMaterial"}));
            materials[materials.length-1].flatShading = true;
            materials.push( new THREE.MeshStandardMaterial({name: "MeshStandardMaterial"}));
            materials.push( new THREE.MeshPhysicalMaterial({name: "MeshPhysicalMaterial"}));
            materials.currPosition = 0;


            var key = [];

            //obsluga klawiatury
            document.addEventListener("keydown", function(event) {key[event.keyCode] = true;});
            document.addEventListener("keyup", function(event) {key[event.keyCode] = false;});

            ///////////////////////////
            //sprawdz gdzie kliknieto
            //
            document.addEventListener("click",  onMouseClick );




			var renderer = new THREE.WebGLRenderer();
			renderer.setSize( window.innerWidth, window.innerHeight );
			//document.body.appendChild( renderer.domElement );
            document.getElementById("WebGL-output").appendChild(renderer.domElement);

			//tworzymy swiatlo ambient
			var ambientLight = new THREE.AmbientLight( 0x808080 );
			//scene.add(ambientLight);
			
			////////////////////////////////////////
			//tworzymy swiatlo punktowe R
			var rLightGroup = new THREE.Group();
			var lightR = new THREE.PointLight( 0xff0000, 1, 100 );
			//light.position.set( 0, 0, 0.0 );
			var bulbR = new THREE.Mesh( new THREE.SphereGeometry( 0.1, 10, 10), new THREE.MeshBasicMaterial({color: 0xff0000}) );
			lightR.position.set( 0, -0.50, 2.0 );
			bulbR.position.set( 0,  -0.50, 2.0 );
			rLightGroup.add(lightR);
			rLightGroup.add(bulbR);

			//scene.add( rLightGroup );
            lightsG.add(rLightGroup);

			////////////////////////////////////////
			//tworzymy swiatlo punktowe G
			var gLightGroup = new THREE.Group();
			var lightG = new THREE.PointLight( 0x00ff00, 1, 100 );
			var bulbG = new THREE.Mesh( new THREE.SphereGeometry( 0.1, 10, 10), new THREE.MeshBasicMaterial({color: 0x00ff00}) );
			lightG.position.set( 0,  -0.50, 2.2 );
			bulbG.position.set( 0,  -0.50, 2.2 );
			gLightGroup.add(lightG);
			gLightGroup.add(bulbG);

			//scene.add( gLightGroup );
            lightsG.add(gLightGroup);

			////////////////////////////////////////
			//tworzymy swiatlo punktowe B
			var bLightGroup = new THREE.Group();
			var lightB = new THREE.PointLight( 0x0000ff, 1, 100 );
			var bulbB = new THREE.Mesh( new THREE.SphereGeometry( 0.1, 10, 10), new THREE.MeshBasicMaterial({color: 0x0000ff}) );
			lightB.position.set( 0,  -0.50, 1.8 );
			bulbB.position.set( 0,  -0.50, 1.8 );
			bLightGroup.add(lightB);
			bLightGroup.add(bulbB);

			//scene.add( bLightGroup );
            lightsG.add(bLightGroup);

            

    		scene.add( lightsG );

            ///////////////////////////////////////
            // Tworzymy plaszczyzne przesunieta o w dol o -1

			var plane = new THREE.Mesh( new THREE.PlaneGeometry( 5, 5, 1, 1), materials[0].clone() );
            plane.position.set (0, -1, 0);
            plane.rotation.x = -Math.PI/2;
            plane.grid = 1;                     //siatka do rysowania geometrii plaszczyzny
            plane.material.shininess = 30;

			scene.add( plane );

            var wireGeom = new THREE.WireframeGeometry(plane.geometry);
            var wireObj = new THREE.LineSegments( wireGeom, new THREE.LineBasicMaterial());
            wireObj.position.set (0, -1, 0);
            wireObj.rotation.x = -Math.PI/2;
			scene.add( wireObj );

			camera.position.z = 4;
            camera.updateMatrixWorld();

			animate();		

            ///////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

			function animate () {
				requestAnimationFrame( animate );

                keyboard();

				rLightGroup.rotation.y += 0.01;
				gLightGroup.rotation.y += 0.015;
				bLightGroup.rotation.y += 0.005;
                
                document.getElementById("output").innerHTML =   "Plane Material: " + plane.material.name + 
                                                                "; grid: " + plane.grid +"x" +plane.grid +"<br>" +
                                                                "shine: " + plane.material.shininess + "<br>";
                
                if(currObject){
                   color += colorStep;
                   currObject.material.color = new THREE.Color(color | currObject.material.oldColor.getHex());

                   //console.log((color| currObject.material.oldColor).toString(16) +"; oldColor = " + currObject.material.oldColor.toString(16));
                    if(color == 0xffffff || color == 0) 
                        colorStep = -colorStep;

                    document.getElementById("output").innerHTML += 
                        "position.y = \t" + currObject.position.y.toFixed(2) + "<br>" +
                        "light intensity = \t" +currObject.parent.children[0].intensity.toFixed(2);

                }

                //

				renderer.render(scene, camera);
			};


            ///////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

            function onMouseClick(event) {
                mouse.x = ( event.clientX / window.innerWidth ) * 2 - 1;
	            mouse.y = - ( event.clientY / window.innerHeight ) * 2 + 1;

                raycaster.setFromCamera( mouse, camera );
                var intersects = raycaster.intersectObjects( lightsG.children, true );

                /////////////////////////////////////////
                //sprawdzamy czy kliknieto na ktores ze swiatel
                //
                if(intersects.length > 0){                                                              
                    if(currObject != intersects[0].object){
                        color = 0;
                        intersects[0].object.material.oldColor = intersects[0].object.material.color;
                        if(currObject)
                            currObject.material.color = currObject.material.oldColor;
                        currObject = intersects[0].object;
                        // currObject.material.color = new THREE.Color(0xffffff);

                    }
                }
                else if(raycaster.intersectObject(plane).length > 0)       //ok, nie kliknieto swiatla, a moze kliknieto podloze?
                {
                    //tak! kliknieto podloze
                    //w takim razie wymieniamy material
                    materials.currPosition ++;
                    var shine = plane.material.shininess;
                    plane.material = materials[materials.currPosition % materials.length].clone();
                    plane.material.shininess = shine;
                }
            }

            ///////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

            function keyboard() {

                //////////////////////////////////////////////////////
                //niestety poniewaz nasza klawiatura nie reaguje na pojedyncze wcisniecie tylko 
                //ta funkcja jest wolana wiele razy na sekunde
                //musimy zbudowac kod dzieki ktoremu bedziemy symulowac wcisniecie i wycisniecie klawisza
                //Algorytm:
                //mamy zmienna stanu klawisza d: dState, ktora jest rowna 1 jesli klawisz jest wcisniety a 0 jesli puszczony
                //w keyboard.dState trzymamy poczatkowa wartosc
                //chcemy wychwycic moment zmiany dState z 0->1 lub 1->0
                //uzywamy XOR na poprzednim i obecnym stanie
                //

                //krok pierwszy to ustawienie stanu poczatkowego
                if(typeof keyboard.dState == 'undefined')
                {
                    //Ustalamy stan 'e' i 'd' przy pierwszym uruchomieniu 
                    keyboard.dState = (key['d'.charCodeAt(0)] | key['D'.charCodeAt(0)]) ? 1 : 0;
                    keyboard.eState = (key['e'.charCodeAt(0)] | key['E'.charCodeAt(0)]) ? 1 : 0;
                }

                //musimy sprawdzic czy zmienil sie status klawiszy e i/lub d
                var dState = (key['d'.charCodeAt(0)] | key['D'.charCodeAt(0)]) ? 1 : 0;
                var eState = (key['e'.charCodeAt(0)] | key['E'.charCodeAt(0)]) ? 1 : 0;
                if(keyboard.dState ^ dState)                                                //jesli prawda to zmienil sie status
                {
                    keyboard.dState = dState;
                    //console.log("zmiana d = " + dState)
                    if(dState == 1) plane.grid--;
                    if(plane.grid == 0) plane.grid = 1;
                    plane.geometry.dispose();                                               //kasuj geometrie
                    plane.geometry = new THREE.PlaneGeometry(5, 5, plane.grid, plane.grid);
                    
                    wireObj.geometry.dispose();
                    wireObj.geometry = new THREE.WireframeGeometry(plane.geometry);
                }
                else if(keyboard.eState ^ eState)
                {
                    keyboard.eState = eState;
                    if(eState == 1) plane.grid++;
                    plane.geometry.dispose();                                               //kasuj geometrie
                    plane.geometry = new THREE.PlaneGeometry(5, 5, plane.grid, plane.grid);
                    
                    wireObj.geometry.dispose();
                    wireObj.geometry = new THREE.WireframeGeometry(plane.geometry);
               }

                if (key['r'.charCodeAt(0)] || key['R'.charCodeAt(0)]) {
                    plane.material.shininess += 1;
                } 
                if (key['f'.charCodeAt(0)] || key['F'.charCodeAt(0)]) {
                    plane.material.shininess -= 1;
                } 
                if (key[32]) {
                    plane.material.shininess = 30;
                }

                
                
                if(!currObject)
                    return;

                if (key['q'.charCodeAt(0)] || key['Q'.charCodeAt(0)]) {
                    currObject.parent.children[0].position.add(new THREE.Vector3(0, 0.02, 0));
                    currObject.parent.children[1].position.add(new THREE.Vector3(0, 0.02, 0));
                } 
                if (key['a'.charCodeAt(0)] || key['A'.charCodeAt(0)]) {
                    currObject.parent.children[0].position.add(new THREE.Vector3(0, -0.02, 0));
                    currObject.parent.children[1].position.add(new THREE.Vector3(0, -0.02, 0));
                } 
                if (key['w'.charCodeAt(0)] || key['W'.charCodeAt(0)]) {
                    currObject.parent.children[0].intensity += 0.01;
                } 
                if (key['s'.charCodeAt(0)] || key['S'.charCodeAt(0)]) {
                    currObject.parent.children[0].intensity -= 0.01;
                } 
               if (key[32]) {
                currObject.parent.children[0].position.setComponent(1, 0.0);
                currObject.parent.children[1].position.setComponent(1, 0.0);
                currObject.parent.children[0].intensity = 1;
                } 

};


		</script>
	</body>
</html>